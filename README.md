# KnowledgeQuest - 本地知识库问答系统

一个基于本地向量库和本地大模型的知识库问答系统，支持文本向量化存储、语义搜索、大模型问答和 Markdown 文档处理。通过结合 Milvus 向量数据库和 Ollama 本地大模型，实现高效、私密且无需联网的知识库构建与智能问答。

## 功能特点

### 文本管理与存储

- **文本向量化**：将文本转换为高维向量并存储，捕捉文本的语义信息
- **主题管理**：为文本添加主题分类，支持按主题组织和筛选文本
- **批量操作**：支持批量插入文本，提高数据导入效率
- **数据清理**：支持按主题清除数据，灵活管理知识库

### 智能搜索与检索

- **语义相似度搜索**：根据语义相似度而非关键词匹配查找文本，找到真正相关的内容
- **多维度筛选**：支持结合主题、相似度等多维度进行筛选和排序

### 文档处理

- **Markdown 智能切片**：支持切分 Markdown 文件并保留文档结构，包括标题层级和内容关系
- **HTML 内容提取**：自动处理 HTML 标签，提取清晰的文本内容

### 大模型交互

- **基于知识库的问答**：结合向量数据库和大模型，实现基于本地知识库的问答功能
- **多轮对话**：支持与大模型进行多轮对话，深入探讨问题
- **上下文增强**：自动为每个问题检索相关文档，提供给大模型作为上下文，提高回答准确性

## 技术栈

### 文本处理与向量化

- **文本切片**：使用 `MarkdownHeaderTextSplitter` 和 `RecursiveCharacterTextSplitter` 对 Markdown 文本进行智能切片，保留文档结构和语义完整性。
- **HTML 处理**：使用 `BeautifulSoup` 处理 HTML 标签，确保内容干净度。
- **向量化模型**：采用 `moka-ai/m3e-base` 模型将文本转换为向量表示，该模型是一个完全开源的中文多模态嵌入模型，不需要 token 即可使用，对中文有特别优化，在中文语料上表现优异，尤其适合检索和语义匹配任务。

### 向量存储与检索

- **向量数据库**：使用 Milvus 作为向量数据库，支持高效的相似度搜索和筛选。
- **相似度计算**：采用余弦相似度 (Cosine Similarity) 计算向量间的语义相似度。
- **元数据管理**：支持为每个文本向量添加主题、标题路径等元数据，并支持按元数据进行筛选。

### 大模型交互

- **本地大模型**：使用 Ollama 加载并运行 `qwen2.5:1.5b` 模型，该模型是通义千问系列的轻量级版本，适合在本地环境运行，具有较好的中文理解和生成能力。
- **检索增强生成**：结合向量检索和大模型生成能力，实现基于知识库的问答功能。系统先检索相关文档，然后将文档作为上下文提供给大模型，使回答更加准确和有针对性。
- **LangChain 框架**：使用 LangChain 框架构建大模型应用，包括提示模板管理、模型调用和输出处理等功能。

### 应用架构

- **知识库问答架构**：采用“知识库构建-向量检索-大模型问答”的架构，实现高效、准确的本地知识问答
- **模块化设计**：将向量数据库操作、文本处理、大模型交互和应用逻辑分离为独立模块，提高代码可维护性和可扩展性
- **单例模式**：大模型交互采用单例模式，确保模型只加载一次，提高性能和资源利用率
- **检索增强生成**：采用 RAG (Retrieval-Augmented Generation) 架构，将向量检索与大模型生成能力结合，提高回答质量
- **命令行界面**：提供交互式命令行界面，支持各种数据操作、查询和大模型交互功能

## 安装与配置

### 前提条件

- Python 3.8+
- Milvus 向量数据库服务
- Ollama (用于运行本地大模型)

### 安装依赖

```bash
# 安装 Python 依赖
pip install -r requirements.txt

# 安装 Ollama (MacOS)
brew install ollama

# 下载并运行大模型
ollama pull qwen2.5:1.5b
```

### 配置环境

1. **启动 Milvus 服务**：
   应用会自动启动本地 Milvus Lite 服务，无需额外配置。

2. **启动 Ollama 服务**：
   ```bash
   ollama serve
   ```
   确保 Ollama 服务在使用 chat 命令前已经启动。

## 使用方法

### 启动应用

```bash
python main.py
```

### 命令行界面

应用提供了交互式命令行界面，支持以下命令：

| 命令 | 描述 | 示例 |
|------|------|------|
| `help` | 显示帮助信息 | `help` |
| `insert <文本>` | 插入单条文本 | `insert 这是一条测试文本` |
| `batchInsert` | 批量插入文本 | `batchInsert` |
| `search <查询文本>` | 搜索相似文本 | `search 查找相似内容` |
| `delete <ID>` | 根据ID删除文本 | `delete 1` |
| `list [主题]` | 列出所有文本，可按主题筛选 | `list` 或 `list 新闻` |
| `count` | 显示文本数量 | `count` |
| `clear [主题]` | 清除文本，可指定主题 | `clear` 或 `clear 新闻` |
| `split <文件路径>` | 切片 Markdown 文件并存入数据库 | `split ./docs/example.md` |
| `chat <问题>` | 与大模型交互，回答问题 | `chat 什么是人工智能` |
| `exit/quit` | 退出程序 | `exit` |

### 详细说明

#### 插入文本

插入单条文本，会提示输入主题（默认为"general"）：

```
> insert 这是一条测试文本
请输入文本主题(直接回车使用默认值'general'): 测试
文本插入成功，ID: 1, 主题: 测试
```

#### 批量插入文本

批量插入多条文本，所有文本使用相同的主题：

```
> batchInsert
请输入文本主题(直接回车使用默认值'general'): 新闻
请输入文本，每行一条，输入空行结束：
今天天气晴朗
股市上涨三个点
科技公司发布新产品

将插入 3 条文本，主题: 新闻
批量插入成功，共 3 条数据
```

#### 搜索文本

根据语义相似度搜索文本：

```
> search 天气如何

搜索结果:
  1. 相似度: 0.8521, 主题: 新闻, 文本: 今天天气晴朗
```

#### 清除文本

清除所有文本或指定主题的文本：

```
> clear
请输入要清除的文本主题(直接回车清除所有文本): 测试
警告: 此操作将清除主题为 '测试' 的所有文本，确定继续吗？(y/n): y
已清除主题为 '测试' 的数据，共 1 条
主题为 '测试' 的文本已清除
```

#### Markdown 文件切片

支持将 Markdown 文件切分成多个语义块并存入向量数据库：

```
> split ./docs/example.md
请输入文本主题(直接回车使用文件名作为主题): 文档
请输入切片大小(直接回车使用默认值'1000'): 800
请输入切片重叠(直接回车使用默认值'200'): 100
正在处理 Markdown 文件: ./docs/example.md
切片大小: 800, 切片重叠: 100
成功处理 Markdown 文件，共生成 15 个切片并存入数据库
```

切片处理会自动提取 Markdown 文件中的标题层级结构，并保留上下文信息，使搜索结果更加准确和有意义。

清除所有文本：

```
> clear
请输入要清除的文本主题(直接回车清除所有文本): 
警告: 此操作将清除所有文本，确定继续吗？(y/n): y
集合 text_collection 已清空，共删除 3 条数据
所有文本已清除
```

#### 与大模型交互

使用大模型回答问题，基于向量检索结果提供上下文：

```
> chat 人工智能有哪些应用
请输入检索结果数量上限(直接回车使用默认值3): 
正在处理问题: '人工智能有哪些应用'...
正在检索与问题相关的文档: 人工智能有哪些应用
找到 3 条相关文档

大模型回答:

人工智能有广泛的运用，如自然语言处理、计算机视觉等。它在医疗诊断、金融分析、自动驾驶等领域发挥了重要作用。随着技术的发展和应用场景的不断拓展，人工智能的应用将会更加广泛。

是否继续对话？(y/n): y
请输入您的问题: 人工智能在医疗领域的应用
正在处理问题: '人工智能在医疗领域的应用'...

大模型回答:

人工智能在医疗领域有多种应用，包括医学影像识别与分析、疾病诊断辅助、药物研发、个性化治疗方案制定、手术机器人辅助手术等。这些应用有助于提高诊断准确率、减轻医护人员工作量、加速新药研发并降低医疗成本。
```

大模型交互支持多轮对话，可以根据上一轮的回答继续提问。系统会为每个问题检索相关文档，并将文档作为上下文提供给大模型，使回答更加准确和有针对性。

## 开发者信息

- 作者: NightsLeon
- 版本: 1.0.0

## 更新日志

### v1.1.0 (2025-03-17)

- 实现基本的向量数据库功能
- 支持 Markdown 文件处理和切片
- 实现命令行界面
- 实现大模型交互功能，支持基于知识库的问答
- 实现大模型单例模式，提高性能
- 更新依赖库，添加 langchain 和 langchain-ollama

## 许可证

暂无。
